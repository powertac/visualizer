<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui">

<h:head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<title>PowerTAC Visualizer</title>
	<ui:insert name="headInclude" />
	<h:outputScript library="js" name="scripts.js" />
	<h:outputStylesheet library="css" name="visualizer.css" />
	<!-- <script src="http://code.highcharts.com/highcharts.js"></script>
	<script src="http://code.highcharts.com/highcharts-more.js"></script>  -->
	<script src="http://code.highcharts.com/modules/exporting.js"></script>
	<script src="http://code.highcharts.com/stock/highstock.js"></script>
	<script src="http://code.highcharts.com/stock/highcharts-more.js"></script>
	<script src="http://code.highcharts.com/stock/modules/exporting.js"></script>

	<h:outputStylesheet library="css" name="modern.css" />
	<h:outputStylesheet library="css" name="site.css" />
	<h:outputScript library="js" name="charts.js" />
	<h:outputStylesheet library="css" name="visualizer.css" />
	<h:outputScript library="javascript" name="pagecontrol.js" />
	<h:outputScript library="javascript" name="dropdown.js" />
	<h:outputScript library="javascript" name="accordion.js" />
	<h:outputScript library="javascript" name="buttonset.js" />
	<h:outputScript library="javascript" name="carousel.js" />
	<h:outputScript library="javascript" name="dialog.js" />
	<h:outputScript library="javascript" name="input-control.js" />
	<h:outputScript library="javascript" name="pagecontrol.js" />
	<h:outputScript library="javascript" name="rating.js" />
	<h:outputScript library="javascript" name="slider.js" />
	<h:outputScript library="javascript" name="tile-slider.js" />
	<h:outputScript library="javascript" name="tile-drag.js" />
	<script type="text/javascript">
		$(document).ready(function() {
			Highcharts.setOptions({
				global : {
					useUTC : true
				}
			});
			handleGlobalMsg(#{globalBean.globalPusher});

		});
		
	</script>

	<ui:insert name="headIncludes" />
</h:head>
<h:body class="modern-ui">

	<p:button rendered="false"></p:button>




	<div class="page" id="page-index">
		<div class="nav-bar">
			<div class="nav-bar-inner padding10">
				<span class="pull-menu"></span> <a href="financecumulative"><span
					class="element brand"> <small>Power TAC Visualizer</small>
				</span></a>

				<div class="divider"></div>

				<ul class="menu">
					<li data-role="dropdown"><a href="#">Finance</a>
						<ul class="dropdown-menu">
							<li><a href="financecumulative">Cumulative scores</a></li>
							<li><a href="financepertimeslot">Per timeslot scores</a></li>
						</ul></li>
					<li data-role="dropdown"><a href="#">Tariff market</a>
						<ul class="dropdown-menu">
							<li><a href="tariffcumulative">Cumulative scores</a></li>
							<li><a href="tariffpertimeslot">Per timeslot scores</a></li>
							<li class="divider"></li>
							<li><a href="tariffanalysis">Tariff analysis</a></li>
							<li class="divider"></li>
							<li><a href="tairffstatistics">Statistics - TODO</a></li>
						</ul></li>
					<li data-role="dropdown"><a href="#">Wholesale market</a>
						<ul class="dropdown-menu">
							<li><a href="wholesalecumulative">Cumulative scores</a></li>
							<li><a href="wholesalepertimeslot">Per timeslot scores</a></li>
							<li class="divider"></li>
							<li><a href="wholesalemarkettxs">Market transactions</a></li>
							<li class="divider"></li>
							<li><a href="wholesaleavgpricepertimeslot">Average price per timeslot</a></li>
							<li class="divider"></li>
							<li><a href="wholesalegencos">GenCos - TODO</a></li>
							<li class="divider"></li>
							<li><a href="wholesalestatistics">Statistics - TODO</a></li>
						</ul></li>
					<li data-role="dropdown"><a href="#">Balancing</a>
						<ul class="dropdown-menu">
							<li><a href="balancingcumulative">Cumulative scores</a></li>
							<li><a href="balancingpertimeslot">Per timeslot scores</a></li>
							<li class="divider"></li>
							<li><a href="balancingstatistics">Statistics - TODO</a></li>
						</ul></li>

					<li data-role="dropdown"><a href="#">Distribution</a>
						<ul class="dropdown-menu">
							<li><a href="distributioncumulative">Cumulative scores</a></li>
							<li><a href="distributionpertimeslot">Per timeslot
									scores</a></li>
							<li class="divider"></li>
							<li><a href="distributionstatistics">Statistics - TODO</a></li>
						</ul></li>
					<li><a href="weatherreport">Weather report</a></li>
				</ul>
				<h:panelGroup rendered="#{!visualizerBean.tournamentMode}">
					<div class="divider"></div>
					<div class="nav-bar-inner">
						<a href="competitioncontrol"><span class="element brand">
								<small>Settings</small><i class="icon-cog"></i>
						</span></a>
					</div>
				</h:panelGroup>
			</div>
		</div>
		<div class="page-region">
			<div class="page-region-content">




				<div class="grid">
					<div class="row">
						<div class="span12 padding10 fg-color-darken text-center">
							<ui:insert name="title" />
							<ui:insert name="maincontent" />
						</div>
					</div>


				</div>

				<div class="grid">
					<div class="row">
						<ui:insert name="rowcontent" />
					</div>
				</div>


				<!-- div class="grid">
					<div class="row">
						<div class="span6 bg-color-yellow" style="height: 80px; text-align: center">
							<br />
							<div id="gameName" class="fg-color-white bigStatusText"
								>
								<h:outputText value="#{visualizerBean.competition.name}"
									 />

							</div>

						</div>

						<div class="span6 bg-color-yellow" style="height: 80px; text-align: center">
							<br />
							<div id="gameStatus" class="fg-color-white normalStatusText" >
								<h:outputText
									rendered="${!visualizerBean.running and !visualizerBean.finished}"
									value="no game" />
								<h:outputText
									rendered="${!visualizerBean.running and visualizerBean.finished}"
									value="game finished" />
								<h:outputText
									rendered="${visualizerBean.running and !visualizerBean.finished}"
									value="game in progress" />
							</div>

						</div>


					</div>
				</div-->


				<div class="grid">
					<div class="row">
						<div class="tile double bg-color-green" data-role="tile-slider"
							data-param-period="5000" data-param-direction="left">
							<div class="tile-content">
								<h2>Profit Leader</h2>
								<br />
								<h4 id="profitBroker"></h4>
								<p>Congrats!</p>

							</div>
							<div class="brand">
								<div class="statusIcon" id="profitAmount" style="float: right"></div>
								<div class=" icon-diamond statusIcon" />
							</div>
						</div>

						<div class="tile double bg-color-orangeDark"
							data-role="tile-slider" data-param-period="5000"
							data-param-direction="left">
							<div class="tile-content">
								<h2>Balance Leader</h2>
								<br />
								<h4 id="balanceBroker"></h4>
								<p>Congrats!</p>

							</div>
							<div class="brand">
								<div class="statusIcon" id="balanceAmount" style="float: right"></div>
								<div class=" icon-meter-slow statusIcon" />
							</div>
						</div>

						<div class="tile double last bg-color-purple" data-role="tile-slider"
							data-param-period="5000" data-param-direction="left">
							<div class="tile-content">
								<h2>Customers Leader</h2>
								<br />
								<h4 id="customersBroker"></h4>
								<p>Congrats!</p>

							</div>
							<div class="brand">
								<div class="statusIcon" id="customersAmount"
									style="float: right"></div>
								<div class=" icon-user statusIcon" />
							</div>
						</div>

						<!-- div class="tile single bg-color-purple" data-role="tile-slider"
							data-param-period="5000" data-param-direction="left">
							<div class="tile-content">
								<h2>Customers Leader2</h2>
								<br />
								<h4 id="customersBroker"></h4>
								<p>Congrats!</p>

							</div>
							<div class="brand">
								<div class="statusIcon" id="customersAmount"
									style="float: right"></div>
								<div class=" icon-user statusIcon" />
							</div>
						</div-->

					</div>
				</div>

				<div class="grid">
					<div class="row">
						<div class="span4 bg-color-red"
							style="height: 80px; text-align: center">
							<br />
							<div class=" icon-clock bigStatusIcon" />
							<div class=" bigStatusText" id="clock"></div>
							<br />


						</div>
						<div class="span8 bg-color-greenDark"
							style="height: 80px; text-align: center">
							<br />
							<div class=" icon-calendar bigStatusIcon" />
							<div class=" bigStatusText" id="date"></div>
							<br />

						</div>
					</div>
				</div>

				<div class="grid">
					<div class="row">
						<div class="span4 bg-color-pinkDark"
							style="height: 80px; text-align: center;">
							<br />
							<div class=" weatherText">Weather info</div>
							<br />


						</div>
						<div class="span2 bg-color-pinkDark"
							style="height: 80px; text-align: center;">
							<br />
							<div class=" icon-thermometer weatherIcon" />
							<div class=" weatherText" id="temperature"></div>
							<br />


						</div>

						<div class="span4 bg-color-pinkDark"
							style="height: 80px; text-align: center;">
							<br />
							<div class=" weatherText" id="windspeed"></div>
							<div class=" icon-arrow-up-left arrow" id="windArrow" />

							<br />


						</div>

						<div class="span2 bg-color-pinkDark"
							style="height: 80px; text-align: center;">
							<br />
							<div class=" icon-sun weatherIcon" id="cloudCover" />

							<br />


						</div>

					</div>
				</div>
				
				<div>
				 <table class="bordered">
                    <thead>
                        <tr class="info">
                            <th>Game name</th>
                            <th>Status</th>
                        </tr>
                    </thead>

                    <tbody>
                        <tr><td id="gameName"><h:outputText value="#{visualizerBean.competition.name}"
									 /></td>
                        	<td id="gameStatus"><h:outputText
									rendered="${!visualizerBean.running and !visualizerBean.finished}"
									value="no game" />
								<h:outputText
									rendered="${!visualizerBean.running and visualizerBean.finished}"
									value="game finished" />
								<h:outputText
									rendered="${visualizerBean.running and !visualizerBean.finished}"
									value="game in progress" />
							</td>
						</tr>
                        
                    </tbody>

                    <tfoot></tfoot>
                </table>
				</div>




				<div class="page">

					<div class="grid">
						<div class="row">
							<br />
							<div class="span3 bg-color-blue padding10 text-center"
								style="height: 170px">
								<h1 class="fg-color-white">Chat</h1>
								<br /> <img
									src="#{resource['images/preloader-w8-line-white.gif']}"
									class="place-right" style="margin: 10px;" />
							</div>

							<div class="span4 border-color-blue padding10"
								style="height: 170px">
								<h:form>
									<h:panelGrid columns="2">
										<h:outputText value="Name*:" />
										<p:inputText value="#{chatBean.name}" required="true"
											style="width:120px" />

										<h:outputText value="Message*:" />
										<p:inputText value="#{chatBean.msg}" required="true"
											style="width:120px" />
									</h:panelGrid>
									<h:outputText value="*required" />
									<p:commandButton value="Send"
										actionListener="#{chatBean.sendMsg}"
										styleClass="standart default place-right" />
								</h:form>
							</div>

							<div class="span5 bg-color-blue padding10">

								<div id="chatwindow" style="height: 150px; overflow-y: scroll;"
									class="fg-color-white">
									<ui:repeat var="msg" value="#{chatGlobal.msgs}">
				#{msg} <br />
									</ui:repeat>
								</div>

							</div>


						</div>
					</div>




				</div>


				<div class="page">
					<div class="nav-bar">
						<div class="nav-bar-inner padding10">
							<span class="element"> 2013, Power TAC </span>
							<div class="divider"></div>
							<span class="element"><a class="fg-color-white"
								href="http://www.powertac.org/">Official website</a> </span>
							<div class="divider"></div>
							<span class="element"><a class="fg-color-white"
								href="http://power-tac-developers.975333.n3.nabble.com/">Developers
									forum</a> </span>
						</div>
					</div>
				</div>

			</div>
		</div>
	</div>
	<p:socket onMessage="handleInfoMsg" channel="/infopush" />
	<p:socket onMessage="handleGlobalMsg" channel="/globalpush" />

	<p:socket onMessage="handleChat" channel="/chat" />
	<script type="text/javascript">
		function handleChat(data) {

			var chatContent = $(PrimeFaces.escapeClientId('chatwindow'));

			chatContent.append(data + '<br />');

			//keep scroll  
			chatContent.scrollTop(chatContent.scrollTop() + 50);
		}
	</script>

	<script type="text/javascript">
		function popupDialog(title, content) {
			$.Dialog({
				'title' : title,
				'content' : content,
				'draggable' : true,
				'overlay' : true,
				'closeButton' : true,
				'buttonsAlign' : 'right',
				'position' : {
					'zone' : 'center'
				},
				'buttons' : {
					'OK' : {
						'action' : function() {
						}
					}
				}
			})
		}
		function handleGlobalMsg(data) {
			
			
			var pushObject = jQuery.parseJSON(data);
			//bad hacking:
			if(pushObject ==null){
				pushObject = data;
			}
			
			var nominations = pushObject["nominations"];

			var balance = nominations["balance"];
			var balBroker = balance["name"];
			var balAmount = balance["amount"]/1000;

			var customerNumber = nominations["customerNumber"];
			var cusNumBroker = customerNumber["name"];
			var cusNumAmount = customerNumber["amount"];

			var profit = nominations["profit"];
			var profitBroker = profit["name"];
			var profitAmount = profit["amount"];

			var weather = pushObject["weather"];
			var cloudCover = weather["cloudCover"];
			var millis = weather["millis"];
			var temperature = weather["temperature"];
			var windDirection = weather["windDirection"];
			var windSpeed = weather["windSpeed"];

			console.log(" " + balBroker + " " + balAmount + " " + cusNumBroker
					+ " " + cusNumAmount + " " + profitBroker + " "
					+ profitAmount + " " + cloudCover + " " + millis + " "
					+ temperature + " " + windDirection + " " + windSpeed);
			document.getElementById("profitBroker").innerHTML = profitBroker;
			document.getElementById("profitAmount").innerHTML = "&euro; "+profitAmount;
			document.getElementById("balanceBroker").innerHTML = balBroker;
			document.getElementById("balanceAmount").innerHTML = +balAmount+" MWh";
			document.getElementById("customersBroker").innerHTML = cusNumBroker;
			document.getElementById("customersAmount").innerHTML = cusNumAmount;
			var d = new Date(millis);
			var date = $.datepicker.formatDate('yy-mm-dd', d);
			var minutes = d.getMinutes();
			if(minutes &lt; 10){
				minutes = "0"+minutes;
			}
			var hour = d.getHours();
			if(hour &lt; 10){
				hour="0"+hour;
			}
			var clock = ""+hour+":"+minutes;
			document.getElementById("date").innerHTML = date;
			document.getElementById("clock").innerHTML = clock;
			document.getElementById("temperature").innerHTML = temperature+"&deg;C";
			document.getElementById("windspeed").innerHTML = windSpeed+" m/s";
			
			
			var arrow = "icon-arrow-up-left";
			
			if (checkRange(windDirection, 337.5, 360)==true){
				 arrow = "icon-arrow-up";
			}
			       
			else if (checkRange(windDirection, 0, 22.5)==true){
			        arrow = "icon-arrow-up";}
		
		else if (checkRange(windDirection, 22.5, 67.5)==true){
			        arrow = "icon-arrow-up-right";}
			        
			        else if (checkRange(windDirection, 67.5, 112.5)==true){
			        arrow = "icon-arrow-right";}
			        
			        else if (checkRange(windDirection, 112.5, 157.5)==true){
			        arrow = "icon-arrow-down-right";}
			
			        else if (checkRange(windDirection, 157.5, 202.5)==true){
			        arrow = " icon-arrow-down";}
			
			        else if (checkRange(windDirection, 202.5, 247.5)==true){
			        arrow = "icon-arrow-down-left";}
			
			        else if (checkRange(windDirection, 247.5, 292.5)==true){
			        arrow = "icon-arrow-left";}
			
			        else if (checkRange(windDirection, 292.5, 337.5)==true){
			        arrow = "icon-arrow-up-left";}
			
			        
			
			document.getElementById("windArrow").className = arrow+" weatherIcon";
			
			var cloudCoverIcon = "icon-sun";
			if (checkRange(cloudCover, 0, 0.2)==true){
				cloudCoverIcon = "icon-sun";
			}
			else if (checkRange(cloudCover, 0.2, 0.5)==true){
				cloudCoverIcon = "icon-cloudy";
			}
			else if (checkRange(cloudCover, 0.5, 0.75)==true){
				cloudCoverIcon = "icon-cloud-4";
			}
			else if (checkRange(cloudCover, 0.75, 1)==true){
				cloudCoverIcon = "icon-cloudy-2";
			}
			
			
			document.getElementById("cloudCover").className = cloudCoverIcon+" weatherIcon";

		}
		function handleInfoMsg(data) {

			var pushObject = jQuery.parseJSON(data);
			var status = pushObject["status"];
			var GAME_STATUS = 'Game status';
			if (status == 'start') {
				var A_NEW_GAME_IS_ABOUT_TO_START = 'A new game is about to start!';
				popupDialog(GAME_STATUS, A_NEW_GAME_IS_ABOUT_TO_START);
				document.getElementById("gameStatus").innerHTML = A_NEW_GAME_IS_ABOUT_TO_START;
				setTimeout("window.location.href=window.location.href;", 5000);
			} else if (status == 'finish') {
				var THE_GAME_HAS_ENDED = 'The game has ended!';
				popupDialog(GAME_STATUS, THE_GAME_HAS_ENDED);
				document.getElementById("gameStatus").innerHTML = THE_GAME_HAS_ENDED;
				setTimeout("window.location.href=window.location.href;", 5000);
			} else {
				document.getElementById("gameName").innerHTML = status;
			}

		}
	</script>



</h:body>

</html>
